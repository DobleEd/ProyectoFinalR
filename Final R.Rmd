---
title: "Analisis de vocalizaciones Megascops guatemalae"
output: html_document
date: "2025-10-22"
---

# Análisis de la variación vocal en la especie *Megascops guatemalae*

#### Proyecto Final: Introducción a R

#### Edgar Eduardo Peña López

## Antecedentes

### Importancia de las vocalizaciones en las aves

Las señales acústicas en las aves resultan igual o más importantes que los despliegues visuales pues suelen emplearse en contextos de migración, alimentación, cortejo, crianza y defensa territorial. Son tan importantes en el reconocimiento de pares que es posible identificar la especie, el sexo, el grupo social e incluso en algunos casos, al individuo específico.

Aunque en la mayoria de las aves la vocalización es una conducta aprendida, existen grupos como los búhos (orden Strigiformes, familia Strigidae) donde la estructura del canto se encuentra fuertemente ligada a la herencia genética. Debido a esta transmisión genética, y a factores como la variación geográfica, la selección sexual y la estructura poblacional las vocalizaciones pueden diferir entre grupos de una misma especie, generando dialectos locales.

### ![](Mguatemalae.jpeg)

### *Megascops guatemalae*

El género *Megascops* se compone de pequeños búhos cornudos con alas redondeadas, cola corta y ojos grandes ubicados en discos faciales, presentan afinidad por los bosques abiertos y se alimentan de pequeños mamíferos, reptiles, insectos y otras aves. Son endemicos del continente americano, con al menos 22 especies distribuidas desde Uruguay hasta Canadá.

*Megascops guatemalae* se distribuye de forma discontinúa desde el norte de México hasta el sur de Nicaragua. Es una especie sedentaria, no migrante y su actividad es mayoritariamente nocturna. El canto territorial típico consiste en una serie de notas cortas, rítmicas y repetitivas, que forman un trino acelerado y uniforme. Se distinguen 7 subespecies tanto por su morfología como por sus vocalizaciones.

## Objetivo

Evaluar si la divergencia en parámetros del canto territorial entre poblaciones del complejo Megascops guatemalae es consistente y suficiente para respaldar límites taxonómicos dentro del complejo.

## Pregunta de investigación

¿En qué medida la divergencia en el canto territorial de las poblaciones del complejo Megascops guatemalae refleja patrones de diferenciación geográfica y ecológica, y qué tan consistentes son estas diferencias entre individuos y poblaciones?

## Metodología

### Vocalizaciones a analizar

Se recopilaron y depuraron vocalizaciones disponibles en bases de datos verificables, como Xenocanto y Macaulay library. Los parametros acústicos de cada vocalización se miden en el software Raven, contemplando al audio completo y a su vez las medidas individuales de cada nota presente. Se obtuvieron 238 vocalizaciones, sin embargo para este estudio se utilizarán 38 vocalizaciones cuya medición general y especifica se recopiló en la base de datos "tablas_apiladas.xlsx".

Las variables medidas son: Tipo de vista, tiempo de inicio, tiempo de final, frecuencia más baja, frecuencia más alta, frecuencia máxima, amplitud máxima, frecuencia pico, tiempo total (delta), amplitud miníma, tiempo pico, longitud, frecuencia total (delta), densidad poder promedio, localidad, latitud, longitud y país; Así como los indicadores: número de nota, Id, Audio.

### Analisis a realizar

La principal intención de este código es identificar las variables con mayor divergencia entre los audios medidos y ubicarlas geográficamente para poder comprobar una diversificación entre los cantos de la especie. El resultado ideal implica variabilidad entre localidades.

(Este estudio es preeliminar ya que no se cuenta con las medidas completas y 38 audios no son una población representativa para 7 especies y 238 registros, pero la intención es replicar el código con la base de datos completa una vez se hayan medido todos los registros vocales.)

## Código

#### Cargamos paquetes

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(FactoMineR)
library(factoextra)
library(writexl)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(viridis)
library(ggspatial)
```

#### Leemos el archivo Excel.

leemos la base de datos, para mayor facilidad la cargamos como objeto.

```{r}
archivo_excel <- "tablas_apiladas.xlsx"
datos <- read_excel(archivo_excel, sheet = 1)
```

#### Filtramos notas numéricas.

En la base de datos tenemos dos tipos de mediciones, las notas individuales (numeradas en la columna "nota") y la medicion del audio completo (no numerada, sólo contiene la leyenda "completo").

Debido a que queremos considerar cada nota en el promedio general del audio, el primer paso es no contabilizar las filas donde la columna nota no esta numerada.

```{r}
datos_filtrados <- datos %>%
  filter(Nota != "Completo")
```

#### Separamos columnas numéricas y categóricas.

```{r}
columnas_numericas <- datos_filtrados %>%
  dplyr::select(where(is.numeric)) %>%
  names()

columnas_categoricas <- datos_filtrados %>%
  dplyr::select(where(is.character)) %>%
  names()
```

#### Generamos un promedio para cada uno de los audios.

Generamos un promedio para cada uno de los audios, utilizamos la columna "Audio", ya que la columna ID es única y el número de nota agruparía de forma errónea los audios, mezclandolos.

```{r}

  promedios_audio <- datos_filtrados %>%
     mutate(across(c( "Low_Freq", "High_Freq", "Max_Freq", "Max_Amp", "Peak_Freq", "Delta_Time", "Min_Amp", "Peak_Time", "Length_frames", "Delta_Freq", "Avg_Power_Density", "Nota"), as.numeric)) %>%
    group_by(Audio) %>%
    summarise(across(c( "Low_Freq", "High_Freq", "Max_Freq", "Max_Amp", "Peak_Freq", "Delta_Time", "Min_Amp", "Peak_Time", "Length_frames", "Delta_Freq", "Avg_Power_Density", "Nota"), ~ mean(., na.rm = TRUE)))
  promedios_audio
```

#### Preparamos los datos para PCA (seleccionando columnas con valores numéricas y excluyendo identificadores).

```{r}
variables_numericas <- c(
  "Low_Freq", "High_Freq", "Max_Freq", "Max_Amp", "Peak_Freq", "Delta_Time", 
  "Min_Amp", "Peak_Time", "Length_frames", "Delta_Freq", "Avg_Power_Density"
)
variables_excluir <- c("Nota", "ID", "Begin_Time", "End_Time","Pais")

variables <- variables_numericas[
  variables_numericas %in% names(promedios_audio) & 
  !variables_numericas %in% variables_excluir
] 

print(variables)

```

#### Ajustamos los datos para el PCA.

Primero eliminamos las columnas constantes, es decir aquellas cuya varianza sea 0, esto para aumentar la confianza del PCA.

```{r}
datos_pca <- promedios_audio %>%
  dplyr::select(all_of(variables)) %>% 
  dplyr::select(where(~ {
    var_calculada <- var(., na.rm = TRUE)
    !is.na(var_calculada) && var_calculada > 0
  }))
```

Nos aseguramos de que todas las columnas sean númericas

```{r}
datos_pca_numeric <- as.data.frame(lapply(datos_pca, function(x) {
  if (is.character(x) || is.factor(x)) {
    as.numeric(as.character(x))
  } else {
    x
  }
}))
```

#### Realizamos PCA.

```{r}
PCA <- prcomp(datos_pca_numeric, scale = TRUE, center = TRUE)
PCA
```

#### Creamos un data frame a partir del PCA, respetando la agrupación.

```{r}
pca_df <- as.data.frame(PCA$x) %>%
  mutate(Audio = promedios_audio$Audio)

pca_df <- pca_df %>%
  left_join(promedios_audio %>% dplyr::select(Audio, any_of(columnas_categoricas)), by = "Audio")
```

#### Graficamos el PCA agrupando por Pais.

Agregamos la variable "Pais" que habíamos descartado previamente.

```{r}
pca_df <- data.frame(PCA$x, Audio = promedios_audio$Audio) %>%
  left_join(distinct(datos_filtrados, Audio, Pais), by = "Audio")

  ggplot(pca_df, aes(x = PC1, y = PC2, color = Pais)) +
    geom_point(size = 3) +
    stat_ellipse(level = 0.95) +
    theme_minimal() +
    labs(title = "PCA - Agrupación por País",
         x = paste("PC1 (", round(summary(PCA)$importance[2,1]*100, 1), "%)"),
         y = paste("PC2 (", round(summary(PCA)$importance[2,2]*100, 1), "%)"))
```

#### PCA por localidad

```{r}
localidades_unicas <- datos_filtrados %>%
  group_by(Audio) %>%
  summarise(Localidad = first(Localidad))

pca_df_loc <- data.frame(PCA$x, Audio = promedios_audio$Audio) %>%
  left_join(localidades_unicas, by = "Audio")

ggplot(pca_df_loc, aes(x = PC1, y = PC2, color = Localidad)) +
  geom_point(size = 3) +
  stat_ellipse(level = 0.95) +
  theme(
  legend.text = element_text(size = 6),
  legend.title = element_text(size = 7),
  legend.key.size = unit(0.2, "cm"),
  legend.box.spacing = unit(0.1, "cm"),
  legend.margin = margin(0, 0, 0, 0 )) +
  labs(title = "PCA - Agrupación por Localidad",
       x = paste("PC1 (", round(summary(PCA)$importance[2,1]*100, 1), "%)"),
       y = paste("PC2 (", round(summary(PCA)$importance[2,2]*100, 1), "%)"))
```

#### Histograma para interpretar la contribución de cada variable en los 2 ejes graficados.

```{r}
contrib_pc1 <- fviz_contrib(PCA, choice = "var", axes = 1, top = 15) 
print(contrib_pc1)

contrib_pc2 <- fviz_contrib(PCA, choice = "var", axes = 2, top = 15) 
print(contrib_pc2)

contrib_total <- fviz_contrib(PCA, choice = "var", axes = 1:2, top = 15) 
print(contrib_total)

```

#### Crear el mapa con Delta_Freq

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

datos_mapa <- pca_df %>% 
  left_join(datos_filtrados %>% 
  dplyr::select(Audio, Latitud, Longitud, Delta_Freq) %>% 
              distinct(Audio, .keep_all = TRUE), 
            by = "Audio") %>% 
  filter(!is.na(Latitud) & !is.na(Longitud)) %>% 
  mutate(Delta_Freq = as.numeric(Delta_Freq))

mapa_delta <- ggplot() + 
  geom_sf(data = world, fill = "lightgreen", color = "grey") + 
  geom_point(data = datos_mapa, aes(x = Longitud, y = Latitud, color = Delta_Freq), size = 4, alpha = 0.8, shape = 19) + 
  scale_color_viridis(name = "Delta Frecuencia", option = "plasma", direction = -1) +  
  theme_minimal() + 
  labs(title = "Distribución Geográfica - Color por Delta Frecuencia", 
       subtitle = paste("Número de registros utilizados:", nrow(datos_mapa)), 
       x = "Longitud", y = "Latitud") + 
  theme(panel.background = element_rect(fill = "lightblue"), 
        panel.grid = element_line(color = "grey"), 
        plot.title = element_text(hjust = 0.5, face = "bold"), 
        plot.subtitle = element_text(hjust = 0.5))

print(mapa_delta)
```

#### Guardar el mapa

```{r}
ggsave("mapa_delta_freq.png", mapa_delta, width = 12, height = 8, dpi = 300) 
```

#### Ajustar el zoom a América del Norte y Central

```{r}
mapa_norte_america <- ggplot() +
  geom_sf(data = world, fill = "#99CC66", color = "black") +
  geom_point(data = datos_mapa, aes(x = Longitud, y = Latitud, color = Delta_Freq), size = 4, alpha = 0.8, shape = 19) +
  scale_color_viridis(name = "Delta Frecuencia", option = "plasma", direction = -1) +
  coord_sf(xlim = c(-120, -30), ylim = c(-10, 35), expand = FALSE) + 
  theme_minimal() +
  labs(title = "Distribución en América del Norte y Centro América - Color por Delta Frecuencia", subtitle = paste("Número de Registros:", nrow(datos_mapa)), x = "Longitud", y = "Latitud")

print(mapa_norte_america)

ggsave("mapa_norte_america.png", mapa_norte_america, width = 10, height = 8, dpi = 300) 
```

#### Mapa con escalas y formato

```{r}
mapa_con_relieve <- ggplot() +  
  geom_sf(data = world, fill = "#99CC66", color = "black") + 
  geom_point(data = datos_mapa, aes(x = Longitud, y = Latitud, color = Delta_Freq), size = 4, alpha = 0.9, shape = 19) +
  geom_point(data = datos_mapa, aes(x = Longitud, y = Latitud), size = 4.2, color = "white", shape = 1, stroke = 0.8) +
  scale_color_viridis(name = "Delta Frecuencia (Hz)", option = "plasma", direction = -1) +
  coord_sf(xlim = c(-120, -30), ylim = c(-10, 35), expand = FALSE) +
  theme_void() + 
  labs(title = "Distribución Geográfica - Delta Frecuencia", subtitle = paste("Número de registros:", nrow(datos_mapa))) +
  annotation_scale(location = "br", pad_x = unit(0.5, "cm"), pad_y = unit(0.5, "cm")) + 
  annotation_north_arrow(location = "tr", pad_x = unit(0.5, "cm"), pad_y = unit(0.5, "cm")) +
  theme( plot.background = element_rect(fill = "white", color = NA), panel.background = element_rect(fill = "#D4F1F9"), plot.title = element_text(face = "bold", hjust = 0.5, size = 16, margin = margin(b = 10)), plot.subtitle = element_text(hjust = 0.5, size = 12, margin = margin(b = 15)), plot.caption = element_text(hjust = 0.5, size = 10, margin = margin(t = 10)), legend.position = "right", legend.title = element_text(face = "bold") )

print(mapa_con_relieve) 
ggsave("mapa_con_relieve.png", mapa_con_relieve, width = 12, height = 9, dpi = 300)
```

## Conclusiones

Existe una variación entre los promedios de cada variable que puede ser observable tanto en el analisis de componentes principales como en el mapa que considera la frecuencia total, pero es necesario considerar otros factores, tanto ecologicos como respecto a la distribución descrita en la literatura para cada subespecie de *Megascops guatemalae*. Sería importante además complementar con otros analisis multivariados o discriminantes que consideren no sólo las similitudes entre las medidas, sino también las diferencias. Sin embargo este código permite una visualización preeliminar favorable que confirma la variación en los parametros acústicos del trino territorial.

## Literatura consultada

Cardona, L. A. H., Ulloa, J., & Vergara, J. L. P. (2021). Detección automatizada de cantos de aves continúa siendo un desafío: el caso de warbleR y Megascops centralis (búho del Chocó). Biota Colombiana, 22(1). <https://doi.org/10.21068/c2021.v22n01a10> Podos, J., & Warren, P. S. (2007). The Evolution of Geographic Variation in Birdsong. En Advances in the study of behavior (pp. 403-458). [https://doi.org/10.1016/s0065-3454(07)37009-5](https://doi.org/10.1016/s0065-3454(07)37009-5){.uri} Reyes, E. & Astudillo-Sánchez, E. (2017). "Notes on the Nest, Owlets, Diet, and Parasites of the Choco Screech-Owl (Megascops guatemalae centralis) in Loma Alta Communal Reserve, Western Ecuador," The Wilson Journal of Ornithology 129(2), 377-381, (1 June 2017). <https://doi.org/10.1676/16-019.1> Robles-Bello, S. (2016). Variación morfologica y vocal en el saltaparedes feliz Pheugopedius felix (Aves: Troglodytidae). [Tesis de licenciatura, Universidad Nacional Autonoma de México] TESIUNAM.
